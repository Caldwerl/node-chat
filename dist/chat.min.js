/*! chat 01-06-2015 */
module.exports=function(a){a.initConfig({pkg:a.file.readJSON("package.json"),jshint:{files:["./*.js"],options:{globals:{jQuery:!0,module:!0,require:!0,console:!0,__dirname:!0,$:!0,io:!0,setTimeout:!0}}},nodeunit:{all:["test/*_test.js"],options:{reporter:"junit",reporterOptions:{output:"test/output"}}},uglify:{options:{banner:'/*! <%= pkg.name %> <%= grunt.template.today("dd-mm-yyyy") %> */\n'},dist:{files:{"dist/<%= pkg.name %>.min.js":["<%= concat.dist.dest %>"]}}},concat:{options:{separator:";"},dist:{src:["./*.js"],dest:"./<%= pkg.name %>.js"}}}),a.loadNpmTasks("grunt-contrib-jshint"),a.loadNpmTasks("grunt-contrib-uglify"),a.loadNpmTasks("grunt-contrib-concat"),a.registerTask("default",["jshint","concat","uglify"])};var socket=io(),$name=$("#login-name"),$pass=$("#login-pass"),$dispNameTxt=$("#chat-name span"),$dispName=$("#chat-name"),$chat=$("#chat-display"),$msg=$("#chat-message"),$nameList=$("#chat-name-list"),$status=$("#chat-status"),$statusTxt=$("#chat-status span"),$loginForm=$("#login-form"),$msgForm=$("#msg-form"),$countTxt=$("#chat-count span"),whitespacePattern=/^\s*$/,statusOld=$statusTxt.text(),alertOld="alert-info",alertCur;$msgForm.submit(function(){"use strict";return whitespacePattern.test($msg.val())||socket.emit("chat message",{name:$dispNameTxt.text(),message:$msg.val()}),$msg.val(""),!1}),$loginForm.submit(function(){"use strict";return whitespacePattern.test($name.val())||whitespacePattern.test($pass.val())||socket.emit("login",{name:$name.val().trim(),pass:$pass.val().trim()}),!1}),socket.on("populate names",function(a){$nameList.children().remove();for(var b in a)$nameList.append($("<li>").text(a[b].name).css("color",a[b].color))}),socket.on("chat message",function(a){if(void 0!==a.length)for(var b=0;b<a.length;b++)$chat.prepend($("<li>").text(a[b].name).append($("<span>").text(": "+a[b].message)));else void 0!==a.message&&$chat.prepend($("<li>").text(a.name).css("color",a.color).append($("<span>").text(": "+a.message)))}),socket.on("add user",function(a){$nameList.append($("<li>").text(a.name).css("color",a.color))}),socket.on("status",function(a){alertCur=a.category,$status.removeClass(alertOld).addClass(alertCur),$statusTxt.text(a.message),setTimeout(function(){$status.addClass(alertOld).removeClass(alertCur),$statusTxt.text(statusOld)},5e3)}),socket.on("conn update",function(a){$countTxt.text(a)}),socket.on("set name",function(a){$dispNameTxt.text(a.name),$loginForm.hide(),$dispName.show()}),socket.on("disconnect",function(a){"transport close"!=a.name&&($chat.prepend($("<li>").text("Server: "+a.name+" has disconnected.")),$("#chat-name-list li:contains("+a.name+")").filter(":first").remove())}),module.exports=function(){"use strict";var a,b,c=Math.random(),d=.618033988749895,e=255,f=Math.floor(6*c),g=.5,h=.95,i=6*c-f,j=h*(1-g),k=h*(1-i*g),l=h*(1-(1-i)*g);switch(c+=d,c%=1,f){case 0:a=h,b=l,e=j;break;case 1:a=k,b=h,e=j;break;case 2:a=j,b=h,e=l;break;case 3:a=j,b=k,e=h;break;case 4:a=l,b=j,e=h;break;case 5:a=h,b=j,e=k}return a=Math.floor(256*a).toString(16),b=Math.floor(256*b).toString(16),e=Math.floor(256*e).toString(16),"#"+a+b+e};var crypto=require("crypto-js");module.exports=function(a,b,c){"use strict";a.find({name_lower:b.name.toLowerCase()}).toArray(function(d,e){if(d&&c(d,null),1==e.length)crypto.SHA256(e[0].salt+b.pass).toString()===e[0].pass?c(null,{functionName:"newConn",data:e[0].name}):c(null,{functionName:"sendStatus",data:{category:"alert-danger",message:"Invalid Login"}});else{var f=crypto.lib.WordArray.random(32).toString(),g=crypto.SHA256(f+b.pass).toString();a.insert({name:b.name,pass:g,salt:f,name_lower:b.name.toLowerCase()}),c(null,{functionName:"newConn",data:b.name})}})};var express=require("express"),app=express(),server=require("http").Server(app),io=require("socket.io")(server),mongo=require("mongodb").MongoClient,favicon=require("serve-favicon"),secureLogin=require("./secure-login"),randomColor=require("./random-color"),port=8080,userList={},userCount=0,welcomeMsg="Welcome to the Empty Datacube. Messages below this are old.";app.use(favicon(__dirname+"/favicon.ico")),app.use(express["static"](__dirname)),app.get("/",function(a,b){b.sendfile("./index.html")}),mongo.connect("mongodb://localhost/chat",function(a,b){"use strict";if(a)throw a;var c=b.collection("chatLog"),d=b.collection("serverLog"),e=b.collection("users");io.on("connection",function(a){var b=!1,f=function(b){a.emit("status",b)},g=function(a){io.emit("conn update",a)},h=function(a,b){for(var c in a)if(a[c].name===b)return!1;return!0},i=function(b){io.to(a.id).emit("populate names",userList),userCount+=1,g(userCount),c.find().sort({$natural:-1}).limit(50).toArray(function(b,c){b&&f({category:"alert-danger",message:"Error fetching messages"}),io.to(a.id).emit("chat message",c.reverse()),io.to(a.id).emit("chat message",{name:"Server",message:welcomeMsg})}),d.insert({socketID:a.id,name:userList[a.id].name,message:"Connect",date:(new Date).toString()}),a.emit("chat message",{name:"Server",message:userList[a.id].name+" has connected."}),a.broadcast.emit("add user",userList[a.id]),f({category:"alert-success",message:"Login Successful"}),io.to(a.id).emit("set name",userList[a.id])};a.on("login",function(c){secureLogin(e,c,function(c,d){c&&(console.log(c),f({category:"alert-danger",message:"Error on DB"})),"sendStatus"===d.functionName?f(d.data):"newConn"===d.functionName&&(h(userList,d.data)?(userList[a.id]={name:d.data,color:randomColor()},b=!0,i(d.data)):f({category:"alert-danger",message:"User already logged in"}))})}),a.on("chat message",function(b){c.insert({socketID:a.id,name:b.name,message:b.message,date:(new Date).toString()}),io.emit("chat message",{name:b.name,message:b.message,color:userList[a.id].color}),f({category:"alert-success",message:"Message sent"})}),a.on("disconnect",function(){b&&(d.insert({socketID:a.id,name:userList[a.id].name,message:"Disconnect",date:(new Date).toString()}),io.emit("disconnect",userList[a.id]),delete userList[a.id],g(userCount-=1))})})}),server.listen(port,function(){console.log("Server now listening on port ",port)});